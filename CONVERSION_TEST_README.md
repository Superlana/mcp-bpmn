# Mermaid to BPMN Conversion Test Suite

This test suite allows you to convert the mermaid source file to BPMN and analyze the results without needing to interact with Claude Desktop.

## Quick Start

### Option 1: Simple Conversion Test
```bash
npm run test:conversion
```

This runs the standalone conversion script that:
- Reads the mermaid source file from `samples/mermaid_source/o2c-process-mermaid.mermaid`
- Converts it to BPMN XML
- Outputs the result to `samples/converted-output.bpmn`
- Provides detailed analysis of the conversion

### Option 2: Full Test Suite
```bash
npm run test:conversion:full
```

This runs both the standalone test and the Jest test suite with comprehensive validation.

### Option 3: Jest Tests Only
```bash
npm run test:mermaid
```

This runs only the Jest test suite for mermaid conversion validation.

## Test Output Analysis

The conversion test provides detailed analysis including:

### ✅ Success Indicators
- **Contains "Send Invoice to Customer": true** - The missing task is properly included
- **Contains "Send Payment Reminder": true** - The other missing task is properly included  
- **Has invalid end event flows: false** - No invalid BPMN flows from end events

### ❌ Current Issues (as of the analysis)
- **Contains "Send Invoice to Customer": false** - Task still missing from conversion
- **Contains "Send Payment Reminder": false** - Task still missing from conversion
- **Has invalid end event flows: true** - Invalid BPMN structure present

### Element Counts
- **Tasks**: Number of BPMN task elements
- **Gateways**: Number of exclusive gateway elements  
- **Start Events**: Should be 1
- **End Events**: Should be 3 (for the three different end paths)
- **Sequence Flows**: Total number of flow connections

## File Locations

### Input Files
- **Mermaid Source**: `samples/mermaid_source/o2c-process-mermaid.mermaid`
- **Expected Good BPMN**: `samples/good/order-to-cash-process_manual.bpmn`
- **Current Bad BPMN**: `samples/bad/order-to-cash-process.bpmn`

### Output Files
- **Converted BPMN**: `samples/converted-output.bpmn` (generated by test)
- **Test Output**: `samples/test-output.bpmn` (generated by Jest tests)

## Interpreting Results

### Expected Behavior (Good BPMN)
- Both critical tasks ("Send Invoice to Customer" and "Send Payment Reminder") are present
- No invalid end event flows
- Proper sequence flow continuity

### Current Behavior (Matches Bad BPMN)
- Missing the two critical tasks
- Has invalid end event flows
- Tasks incorrectly flow to end events instead of continuing the process

## Running Tests During Development

### Watch Mode
```bash
npm run test:watch -- tests/integration/mermaid-conversion.test.ts
```

### Build and Test
```bash
npm run build && npm run test:conversion
```

## Troubleshooting

### Dependencies
If tests fail, ensure dependencies are installed:
```bash
npm install
```

### Build Issues
If TypeScript compilation errors occur:
```bash
npm run build
```

### Module Resolution
The project uses ES modules. If you encounter import issues, check that:
- `"type": "module"` is set in package.json
- File extensions are included in imports (.js not .ts)

## Test Implementation

The test suite includes:

1. **Standalone Test Script** (`test-conversion.ts`)
   - Direct conversion testing
   - File I/O operations
   - Detailed analysis output

2. **Jest Integration Tests** (`tests/integration/mermaid-conversion.test.ts`)
   - Comprehensive validation
   - Structured test cases
   - Comparison with reference files

3. **Shell Script Runner** (`run-conversion-test.sh`)
   - Automated setup and execution
   - Dependency checking
   - Combined test execution

## Next Steps

Use these tests to:
1. **Validate Current State**: Confirm the conversion issues
2. **Test Fixes**: Run tests after implementing the proposed code improvements
3. **Regression Testing**: Ensure changes don't break other functionality
4. **Continuous Integration**: Integrate into CI/CD pipeline

The tests will help verify when the conversion issues are resolved and the output matches the expected good BPMN structure.